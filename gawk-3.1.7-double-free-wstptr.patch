From 09d7f51b9de3ec0b5fa187b69e3aeaa74db82845 Mon Sep 17 00:00:00 2001
From: "Vojtech Vitek (V-Teq)" <vvitek@redhat.com>
Date: Mon, 13 Feb 2012 16:47:10 +0100
Subject: [PATCH] Fix double free in free_wstr

Accepted by upstream: http://lists.gnu.org/archive/html/bug-gnu-utils/2010-11/msg00005.html
---
 node.c |    9 +++++++++
 1 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/node.c b/node.c
index 0dd4bda..6866c67 100644
--- a/node.c
+++ b/node.c
@@ -755,6 +755,15 @@ str2wstr(NODE *n, size_t **ptr)
 
 	assert((n->flags & (STRING|STRCUR)) != 0);
 
+	/*
+	 * Don't convert global null string or global null field
+	 * variables to a wide string. They are both zero-length anyway.
+	 * This also avoids future double-free errors while releasing
+	 * shallow copies, eg. *tmp = *Null_field; free_wstr(tmp);
+	 */
+	if (n == Nnull_string || n == Null_field)
+		return n;
+
 	if ((n->flags & WSTRCUR) != 0) {
 		if (ptr == NULL)
 			return n;
-- 
1.7.6.2

